From 0b514d9313bf872b26f0afead909b77c96105808 Mon Sep 17 00:00:00 2001
From: q66 <q66@chimera-linux.org>
Date: Mon, 20 Oct 2025 23:00:12 +0200
Subject: [PATCH 15/16] work around broken ecosystem hackery when bootstrapping

---
 src/bootstrap/src/core/build_steps/compile.rs | 5 ++++-
 src/bootstrap/src/lib.rs                      | 1 +
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/bootstrap/src/core/build_steps/compile.rs b/src/bootstrap/src/core/build_steps/compile.rs
index d105f128b..e9072ca65 100644
--- a/src/bootstrap/src/core/build_steps/compile.rs
+++ b/src/bootstrap/src/core/build_steps/compile.rs
@@ -764,7 +764,10 @@ impl Step for StdLink {
                 let _ = fs::remove_dir_all(sysroot.join("lib/rustlib/src/rust"));
             }
 
-            builder.cp_link_r(&builder.initial_sysroot.join("lib"), &sysroot.join("lib"));
+            builder.cp_link_r(
+                &builder.initial_sysroot.join("lib/rustlib"),
+                &sysroot.join("lib/rustlib"),
+            );
         } else {
             if builder.download_rustc() {
                 // Ensure there are no CI-rustc std artifacts.
diff --git a/src/bootstrap/src/lib.rs b/src/bootstrap/src/lib.rs
index a78506c39..7a04ea4ae 100644
--- a/src/bootstrap/src/lib.rs
+++ b/src/bootstrap/src/lib.rs
@@ -485,6 +485,7 @@ impl Build {
             .run_capture_stdout(&config)
             .stdout()
             .trim()
+            .replace("lib64", "lib").replace("lib32", "lib")
             .to_owned();
 
         let initial_target_dir = Path::new(&initial_target_libdir)
-- 
2.52.0

