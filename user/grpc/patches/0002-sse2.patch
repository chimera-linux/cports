From 4be5e027b49d00fb4ce7fa4b054fe99ab22b14b7 Mon Sep 17 00:00:00 2001
From: Esun Kim <veblush@google.com>
Date: Wed, 30 Oct 2024 14:04:10 -0700
Subject: [PATCH] CMake check code

---
 CMakeLists.txt                    | 4 +++-
 templates/CMakeLists.txt.template | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 61892f2a2b7f6..5e5400baef82d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -268,7 +268,9 @@ set(gRPC_USE_PROTO_LITE OFF CACHE BOOL "Use the protobuf-lite library")
 if(UNIX)
   if(${CMAKE_SYSTEM_NAME} MATCHES "Linux")
     set(_gRPC_PLATFORM_LINUX ON)
-    if(NOT CMAKE_CROSSCOMPILING AND CMAKE_SIZEOF_VOID_P EQUAL 4)
+    # Boring SSL needs -msse2 build option on 32-bit x86
+    # See https://github.com/google/boringssl/commit/56d3ad9d23bc130aa9404bfdd1957fe81b3ba498
+    if(CMAKE_SYSTEM_PROCESSOR MATCHES "i[3-6]86" AND CMAKE_SIZEOF_VOID_P EQUAL 4)
       message("+++ Enabling SSE2 for ${CMAKE_SYSTEM_PROCESSOR}")
       set(_gRPC_C_CXX_FLAGS "${_gRPC_C_CXX_FLAGS} -msse2")
     endif()
diff --git a/templates/CMakeLists.txt.template b/templates/CMakeLists.txt.template
index f5b7480d639b6..1904e074c50d7 100644
--- a/templates/CMakeLists.txt.template
+++ b/templates/CMakeLists.txt.template
@@ -374,7 +374,9 @@
   if(UNIX)
     if(<%text>${CMAKE_SYSTEM_NAME}</%text> MATCHES "Linux")
       set(_gRPC_PLATFORM_LINUX ON)
-      if(NOT CMAKE_CROSSCOMPILING AND CMAKE_SIZEOF_VOID_P EQUAL 4)
+      # Boring SSL needs -msse2 build option on 32-bit x86
+      # See https://github.com/google/boringssl/commit/56d3ad9d23bc130aa9404bfdd1957fe81b3ba498
+      if(CMAKE_SYSTEM_PROCESSOR MATCHES "i[3-6]86" AND CMAKE_SIZEOF_VOID_P EQUAL 4)
         message("+++ Enabling SSE2 for <%text>${CMAKE_SYSTEM_PROCESSOR}</%text>")
         set(_gRPC_C_CXX_FLAGS "<%text>${_gRPC_C_CXX_FLAGS}</%text> -msse2")
       endif()
