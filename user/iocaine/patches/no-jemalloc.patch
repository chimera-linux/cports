From 5b4ad0c1bba37422673add164072339cfb77d469 Mon Sep 17 00:00:00 2001
From: Ayush Agarwal <ayush@ayushnix.com>
Date: Tue, 23 Dec 2025 17:27:10 +0530
Subject: [PATCH] remove jemalloc for Chimera Linux packaging

Signed-off-by: Ayush Agarwal <ayush@ayushnix.com>
---
 Cargo.lock         | 21 ---------------------
 Cargo.toml         |  4 +---
 src/bin/iocaine.rs |  4 ----
 3 files changed, 1 insertion(+), 28 deletions(-)

diff --git a/Cargo.lock b/Cargo.lock
index 9fa4441..cfaa567 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1690,17 +1690,16 @@ dependencies = [
  "sanitize-filename",
  "sd-notify",
  "serde",
  "serde_json",
  "serde_yaml",
  "sfv",
  "snafu",
  "spop",
- "tikv-jemallocator",
  "tokio",
  "tokio-listener",
  "tokio-stream",
  "tokio-util",
  "toml 0.9.10+spec-1.1.0",
  "tower-http",
  "tracing",
  "tracing-subscriber",
@@ -3931,36 +3930,16 @@ dependencies = [
 name = "thread_local"
 version = "1.1.9"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "f60246a4944f24f6e018aa17cdeffb7818b76356965d03b07d6a9886e8962185"
 dependencies = [
  "cfg-if",
 ]
 
-[[package]]
-name = "tikv-jemalloc-sys"
-version = "0.6.1+5.3.0-1-ge13ca993e8ccb9ba9847cc330696e02839f328f7"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "cd8aa5b2ab86a2cefa406d889139c162cbb230092f7d1d7cbc1716405d852a3b"
-dependencies = [
- "cc",
- "libc",
-]
-
-[[package]]
-name = "tikv-jemallocator"
-version = "0.6.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "0359b4327f954e0567e69fb191cf1436617748813819c94b8cd4a431422d053a"
-dependencies = [
- "libc",
- "tikv-jemalloc-sys",
-]
-
 [[package]]
 name = "time"
 version = "0.3.44"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 checksum = "91e7d9e3bb61134e77bde20dd4825b97c010155709965fedf0f49bb138e52a9d"
 dependencies = [
  "deranged",
  "itoa",
diff --git a/Cargo.toml b/Cargo.toml
index 5d2bc82..936ea39 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -63,44 +63,42 @@
   ] }
   sanitize-filename = "0.6.0"
   serde = { version = "1.0.219", features = ["derive", "rc"] }
   serde_json = "1.0.140"
   serde_yaml = "0.9.34"
   sfv = "0.14.0"
   snafu = { version = "0.8.9", features = ["rust_1_81"] }
   spop = "0.10"
-  tikv-jemallocator = { version = "0.6.0", optional = true }
   tokio = { version = "1.45.1", features = [
     "rt-multi-thread",
     "macros",
     "signal",
   ] }
   tokio-listener = { version = "0.5.1", features = ["axum08", "serde"] }
   tokio-stream = "0.1"
   tokio-util = { version = "0.7", features = ["codec"] }
   toml = { version = "0.9.5", features = ["preserve_order"] }
   tower-http = { version = "0.6.6", features = ["trace"] }
   tracing = "0.1.41"
   tracing-subscriber = { version = "0.3.19", features = ["json", "env-filter"] }
   upon = { version = "0.10.0", default-features = false, features = [
     "functions",
     "serde",
   ] }
   urlencoding = "2.1.3"
   uuid = { version = "1.19.0", features = ["v4", "v5"] }
 
 [target.'cfg(target_os = "linux")'.dependencies]
   sd-notify = "0.4.5"
 
 [features]
   tokio-console = ["dep:console-subscriber", "tokio/tracing"]
-  jemalloc = ["dep:tikv-jemallocator"]
   lua = ["dep:mlua"]
-  default = ["jemalloc", "lua"]
+  default = ["lua"]
 
 [profile.release]
   strip = true
   panic = "abort"
   lto = true
   codegen-units = 1
 
 [profile.perf]
diff --git a/src/bin/iocaine.rs b/src/bin/iocaine.rs
index e4520d1..2588a99 100644
--- a/src/bin/iocaine.rs
+++ b/src/bin/iocaine.rs
@@ -1,17 +1,13 @@
 // SPDX-FileCopyrightText: 2025 Gergely Nagy
 // SPDX-FileContributor: Gergely Nagy
 //
 // SPDX-License-Identifier: MIT
 
-#[cfg(all(not(target_env = "musl"), feature = "jemalloc"))]
-#[global_allocator]
-static GLOBAL: tikv_jemallocator::Jemalloc = tikv_jemallocator::Jemalloc;
-
 use anyhow::Result;
 use clap::{Parser, Subcommand};
 
 use iocaine::dominatrix::Config;
 use iocaine::morgue::Body;
 
 mod commands;
 use commands::show::{self, ShowCommands};
-- 
2.52.0

